<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hypomnemata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root {
      --bg:#f9f8f5;
      --card:#3a3a3a;
      --text:#000000;
      --border:#2b3242;
      --footer-bg:#3a3a3a;
      --footer-text:#f9f8f5;
      --highlight:#d4a44b;
      --works:#d5c7b3;
    }
    html, body {
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.5 "Inter",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      overflow:hidden;
    }
    .wrap {
      height:100vh;
      width:100%;
      display:flex;
      flex-direction:column;
    }
    header {
      flex:0 0 auto;
      padding:10px 16px 12px;
      background:var(--card);
      display:flex;
      flex-direction:column;
      gap:6px;
      border-bottom:1px solid var(--border);
      z-index:10;
      color:#fff;
    }
    .header-top {
      display:flex;
      align-items:center;
      justify-content:space-between;
      width:100%;
    }
    header h1 {
      font-size:16px;
      margin:0;
      color:white;
      font-weight:600;
    }
    .header-bottom {
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:flex-start;
      width:100%;
      gap:12px;
    }
    .hypo-desc {
      color:#fff;
      font-size:14px;
      font-weight:400;
      line-height:1.4;
      max-width:960px;
      opacity:.9;
      margin-top:4px;
      flex:1 1 60%;
      min-width:240px;
    }
    .legend-block {
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      color:white;
      flex:0 0 auto;
      min-width:max-content;
    }
    .legend {
      display:flex;
      flex-wrap:wrap;
      row-gap:6px;
      column-gap:10px;
      align-items:center;
      color:white;
      font-size:16px;
      font-weight:500;
    }

    .author-icon,
    .philosophy-icon,
    .practice-icon,
    .principle-icon,
    .works-icon {
      width:12px;
      height:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:50%;
      font-size:12px;
      line-height:1;
      background:transparent;
      border:none;
      color:#000;
    }

    .philosophy-icon { color:#b4c8a8; }
    .practice-icon   { color:#e8c670; }
    .principle-icon  { color:#e8b7b7; }
    .author-icon     { color:#000000; }
    .works-icon      { color:var(--works); }
    .citation-icon   { color:#88c3c0; }

    .physics-toggle {
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
      line-height:1.2;
      font-weight:500;
      color:#fff;
      margin-top:4px;
      justify-content:flex-end;
      width:100%;
    }
    .switch {
      position:relative;
      display:inline-block;
      width:34px;
      height:18px;
      flex-shrink:0;
    }
    .switch input {opacity:0;width:0;height:0;}
    .slider {
      position:absolute;
      cursor:pointer;
      top:0;left:0;right:0;bottom:0;
      background-color:#555;
      border-radius:10px;
      transition:.2s;
      border:1px solid #222;
    }
    .slider:before {
      position:absolute;
      content:"";
      height:12px;
      width:12px;
      left:3px;
      top:2px;
      background-color:#fff;
      border-radius:50%;
      transition:.2s;
      box-shadow:0 1px 2px rgba(0,0,0,.6);
    }
    input:checked + .slider {background-color:var(--highlight);border-color:#3a3a3a;}
    input:checked + .slider:before {transform:translateX(16px);}

    #viz {
      flex:1;
      min-height:0;
      position:relative;
      background:transparent;
      z-index:0;
      overflow:hidden;
    }

    #details {
      flex:0 0 auto;
      background:var(--footer-bg);
      color:var(--footer-text);
      border-top:1px solid #4a4a4a;
      box-shadow:0 -4px 12px rgba(0,0,0,.25);
      padding:20px 0 24px;
      font-size:16px;
      line-height:1.5;
    }
    .details-inner {
      max-width:960px;
      margin:0 auto;
      width:100%;
      padding:0 24px;
      min-height:140px;
    }
    #details h2 {
      margin:0 0 6px;
      font-size:16px;
      font-weight:600;
      color:var(--footer-text);
      line-height:1.3;
    }
    #details .meta {
      font-size:12px;
      font-weight:500;
      color:#ccc;
      margin-bottom:6px;
      text-transform:capitalize;
      line-height:1.2;
    }
    #details .desc {
      font-size:13px;
      color:var(--footer-text);
      white-space:pre-wrap;
      line-height:1.5;
    }
  </style>
  <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-top">
        <h1>Hypomnemata</h1>
      </div>

      <div class="header-bottom">
        <div class="hypo-desc">
          Hypomnemata (Greek: ὑπομνήματα) were personal notebooks or written records used in antiquity as aids to memory, reflection, and ethical self-formation. They were not merely diaries but spiritual exercises — tools for shaping one’s moral and philosophical life through the active recollection and application of knowledge.
        </div>

        <div class="legend-block">
          <div class="legend">
            <span class="philosophy-icon"><i class="fa-solid fa-brain"></i></span><small>Philosophy</small>
            <span class="principle-icon"><i class="fa-solid fa-columns"></i></span><small>Principle</small>
            <span class="practice-icon"><i class="fa-solid fa-sync-alt"></i></span><small>Practice</small>
            <span class="author-icon"><i class="fa-solid fa-user"></i></span><small>Author</small>
            <span class="works-icon"><i class="fa-solid fa-book"></i></span><small>Works</small>
            <span class="citation-icon"><i class="fa-solid fa-comment-dots"></i></span><small>Citation</small>
          </div>

          <div class="physics-toggle">
            <span>Dynamic graph</span>
            <label class="switch">
              <input type="checkbox" id="physicsToggle" checked />
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </header>

    <div id="viz"></div>

    <section id="details">
      <div class="details-inner">
        <h2 id="details-title">Select a node</h2>
        <div class="meta" id="details-type">—</div>
        <div class="desc" id="details-desc">Click any node in the graph to see its description here.</div>
      </div>
    </section>
  </div>

  <script>
  (function(){
    var endpoint = "/api/graph";

    var container = document.getElementById("viz");
    var titleEl   = document.getElementById("details-title");
    var typeEl    = document.getElementById("details-type");
    var descEl    = document.getElementById("details-desc");
    var toggle    = document.getElementById("physicsToggle");

    // palette map for groups
    var colors = {
      PHILOSOPHY : "#b4c8a8",
      PRINCIPLE  : "#e8b7b7",
      CONCEPT    : "#b8cde2",
      PRACTICE   : "#f3d9a4",
      RELATION   : "#d5c7b3",
      WORKS      : "#d5c7b3"
    };

    function getId(o){
      return (o && (o.id || o.identity || o.elementId || (o.properties && o.properties.id))) || null;
    }

    function getLabel(o){
      if (o && o.properties){
        if (o.properties.title) return o.properties.title;
        if (o.properties.name)  return o.properties.name;
      }
      return (o.labels && o.labels[0]) || "Node";
    }

    function getDesc(o){
      var p = o.properties || {};
      return (p.description && p.description.trim())
        ? p.description
        : "No description available.";
    }

    function getType(o){
      return (o.labels && o.labels[0] ? o.labels[0].toLowerCase() : "node");
    }

    function isAuthorLabel(primary){
      return primary && primary.toUpperCase() === "AUTHOR";
    }
    function isPhilosophyLabel(primary){
      return primary && primary.toUpperCase() === "PHILOSOPHY";
    }
    function isPracticeLabel(primary){
      return primary && primary.toUpperCase() === "PRACTICE";
    }
    function isPrincipleLabel(primary){
      return primary && primary.toUpperCase() === "PRINCIPLE";
    }
    function isCitationLabel(primary){
      return primary && primary.toUpperCase() === 'CITATION';
    }
    function isWorksLabel(primary){
      return primary && primary.toUpperCase() === "WORKS";
    }

    // helper to decorate node label with +/- toggle indicator
    function withToggleIndicator(baseLabel, expanded, hasChildren){
      if(!hasChildren) return baseLabel;
      return expanded ? (baseLabel + "  -") : (baseLabel + "  +");
    }

    function buildNode(n){
      var primary = (n.labels && n.labels[0]) || "Node";

      var base = {
        id    : getId(n),
        label : getLabel(n),
        group : primary,
        _desc : getDesc(n),
        _type : getType(n),

        _expanded:false,
        _children:new Set(),
        _baseLabel:null
      };

      if (isAuthorLabel(primary)) {
        base.shape = "icon";
        base.icon = {
          face: "FontAwesome",
          code: "",
          size: 30,
          color: "#000"
        };
      } else if (isPhilosophyLabel(primary)) {
        base.shape = "icon";
        base.icon = {
          face: "FontAwesome",
          code: "",
          size: 35,
          color: colors[primary] || "#b4c8a8"
        };
      } else if (isPracticeLabel(primary)) {
        base.shape = "icon";
        base.icon = {
          face: "FontAwesome",
          code: "",
          size: 35,
          color: "#e8c670"
        };
      } else if (isPrincipleLabel(primary)) {
        base.shape = "icon";
        base.icon = {
          face: "FontAwesome",
          code: "",
          size: 30,
          color: "#e8b7b7"
        };
      } else if (isCitationLabel(primary)) {
        base.shape = "icon";
        base.icon = {
          face: "FontAwesome",
          code: "",
          size: 30,
          color: "#88c3c0"
        };
      } else if (isWorksLabel(primary)) {
        base.shape = "icon";
        base.icon = {
          face: "FontAwesome",
          code: "",
          size: 30,
          color: colors[primary] || "#d5c7b3"
        };
      } else {
        base.color = {
          background: colors[primary] || "#d5c7b3",
          border: "#333",
          highlight: { background: "#d4a44b", border: "#3a3a3a" },
          hover:     { background: "#d4a44b", border: "#3a3a3a" }
        };
        base.shape = "dot";
        base.size = 23;
        base.borderWidth = 2;
        base.font = { color:"#000", size:16, face:"Inter, system-ui" };
      }

      return base;
    }

    // global-ish structures
    var nodeMap   = new Map(); // uuid -> nodeData
    var edgeMap   = new Map(); // edgeId -> edgeData
    var adjIndex  = new Map(); // uuid -> Set of neighbour uuids
    var edgeIndex = new Map(); // parentUuid -> Map(childUuid -> Set(edgeIds))
    var ownership = new Map(); // childUuid -> Set(parentUuids)

    function addOwnership(parentId, childId){
      if(!ownership.has(childId)) ownership.set(childId, new Set());
      ownership.get(childId).add(parentId);
    }
    function removeOwnership(parentId, childId){
      if(!ownership.has(childId)) return;
      ownership.get(childId).delete(parentId);
    }
    function hasAnyOwner(childId){
      return ownership.has(childId) && ownership.get(childId).size > 0;
    }

    var nodesDS, edgesDS, net;

    function indexEdge(edgeObj){
      var f = edgeObj.from;
      var t = edgeObj.to;
      if(!adjIndex.has(f)) adjIndex.set(f, new Set());
      if(!adjIndex.has(t)) adjIndex.set(t, new Set());
      adjIndex.get(f).add(t);
      adjIndex.get(t).add(f);

      if(!edgeIndex.has(f)) edgeIndex.set(f, new Map());
      if(!edgeIndex.get(f).has(t)) edgeIndex.get(f).set(t, new Set());
      edgeIndex.get(f).get(t).add(edgeObj.id);

      if(!edgeIndex.has(t)) edgeIndex.set(t, new Map());
      if(!edgeIndex.get(t).has(f)) edgeIndex.get(t).set(f, new Set());
      edgeIndex.get(t).get(f).add(edgeObj.id);
    }

    function getBaseNodeLabel(n){
      if(!n._baseLabel) n._baseLabel = n.label.replace(/\s[+-]$/,'');
      return n._baseLabel;
    }

    function updateNodeToggleIndicator(nodeId){
      var n = nodeMap.get(nodeId);
      if(!n) return;
      var neighbours = adjIndex.get(nodeId) || new Set();
      var hasChildren = neighbours.size > 0;
      var newLabel = withToggleIndicator(
        getBaseNodeLabel(n),
        n._expanded,
        hasChildren
      );
      nodesDS.update({id: nodeId, label: newLabel});
    }

    function expandNode(nodeId){
      var n = nodeMap.get(nodeId);
      if(!n) return;

      var neighbours = adjIndex.get(nodeId) || new Set();
      neighbours.forEach(childId => {
        if(childId === nodeId) return;

        addOwnership(nodeId, childId);
        n._children.add(childId);

        if(!nodesDS.get(childId)){
          var childNodeObj = nodeMap.get(childId);
          if(childNodeObj){
            nodesDS.add({
              ...childNodeObj,
              label: withToggleIndicator(
                getBaseNodeLabel(childNodeObj),
                childNodeObj._expanded,
                (adjIndex.get(childId) || new Set()).size > 0
              )
            });
          }
        }

        if(edgeIndex.has(nodeId) && edgeIndex.get(nodeId).has(childId)){
          edgeIndex.get(nodeId).get(childId).forEach(eid => {
            if(!edgesDS.get(eid)){
              edgesDS.add(edgeMap.get(eid));
            }
          });
        }
      });

      n._expanded = true;
      updateNodeToggleIndicator(nodeId);
    }

    function collapseNode(nodeId){
      var n = nodeMap.get(nodeId);
      if(!n) return;

      n._children.forEach(childId => {
        removeOwnership(nodeId, childId);

        if(!hasAnyOwner(childId)){
          if(nodesDS.get(childId)){
            nodesDS.remove(childId);
          }

          if(edgeIndex.has(nodeId) && edgeIndex.get(nodeId).has(childId)){
            edgeIndex.get(nodeId).get(childId).forEach(eid => {
              if(edgesDS.get(eid)){
                edgesDS.remove(eid);
              }
            });
          }
        }
      });

      n._children.clear();
      n._expanded = false;
      updateNodeToggleIndicator(nodeId);
    }

    function toggleNode(nodeId){
      var n = nodeMap.get(nodeId);
      if(!n) return;

      if(n._expanded){
        collapseNode(nodeId);
      } else {
        expandNode(nodeId);
      }
    }

    fetch(endpoint + "?limit=1000")
      .then(r => r.json())
      .then(d => {
        var rows = (d && d.data && d.data.values) || [];

        var rawNodes = [];
        var rawEdges = [];

        rows.forEach(row => {
          if (row[0]) rawNodes.push(row[0]);
          if (row[2]) rawNodes.push(row[2]);
          if (row[1]) rawEdges.push(row[1]);
        });

        rawNodes.forEach(n => {
          var i = getId(n);
          if (i && !nodeMap.has(i)) {
            nodeMap.set(i, buildNode(n));
          }
        });

        rawEdges.forEach(e => {
          var i = getId(e),
              f = e.startNodeElementId || e.start || e.from,
              t = e.endNodeElementId   || e.end   || e.to;

          if (i && f && t && !edgeMap.has(i)) {
            var lab = e.type
              ? "<i>" + e.type
                  .replace(/_/g," ")
                  .toLowerCase()
                  .replace(/^\w/, c => c.toUpperCase()) + "</i>"
              : "";

            var edgeObj = {
              id: i,
              from: f,
              to: t,
              label: lab,
              arrows: "to",
              length: 260,
              color: {
                color: "#d5c7b3",
                highlight: "#d4a44b",
                hover: "#d4a44b"
              },
              font: {
                multi: "html",
                face: "Inter",
                color: "#000"
              },
              smooth: false,
              width:1.5
            };
            edgeMap.set(i, edgeObj);
            indexEdge(edgeObj);
          }
        });

        nodesDS = new vis.DataSet([]);
        edgesDS = new vis.DataSet([]);

        nodeMap.forEach((nObj, uuid) => {
          nodesDS.add({
            ...nObj,
            label: withToggleIndicator(
              getBaseNodeLabel(nObj),
              nObj._expanded,
              (adjIndex.get(uuid) || new Set()).size > 0
            )
          });
        });

        edgeMap.forEach((eObj, eid) => {
          edgesDS.add(eObj);
        });

        net = new vis.Network(
          container,
          { nodes: nodesDS, edges: edgesDS },
          {
            nodes: {
              shape: "dot",
              size: 23,
              borderWidth: 2,
              font: { color:"#000", size:16, face:"Inter, system-ui" }
            },
            edges: {
              width: 1.5,
              color: {
                color:"#d5c7b3",
                highlight:"#d4a44b",
                hover:"#d4a44b"
              },
              smooth: false,
              font: { multi:"html", face:"Inter", color:"#000" }
            },
            interaction: { hover:true, tooltipDelay:150 },
            physics: {
              enabled: true,
              solver: "forceAtlas2Based",
              forceAtlas2Based: {
                gravitationalConstant: -30,
                centralGravity: 0.0005,
                springLength: 280,
                springConstant: 0.03,
                avoidOverlap: 1
              },
              stabilization: { iterations: 400 }
            }
          }
        );

        net.on("click", p => {
          if (p.nodes.length > 0) {
            var clickedId = p.nodes[0];
            var n = nodeMap.get(clickedId);

            titleEl.textContent = getBaseNodeLabel(n);
            typeEl.textContent  = n._type;
            descEl.textContent  = n._desc;

            toggleNode(clickedId);
          }
        });

        toggle.addEventListener("change", () => {
          net.setOptions({ physics:{ enabled: toggle.checked } });
        });
      });
  })();
  </script>
</body>
</html>
