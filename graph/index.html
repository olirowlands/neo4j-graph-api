<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hypomnemata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body>
  <header>
    <h1>Hypomnemata</h1>
    <div class="legend">
      <span><i class="fa-solid fa-brain" style="color:#b4c8a8"></i></span> Philosophy
      <span><i class="fa-solid fa-columns" style="color:#e8b7b7"></i></span> Principle
      <span><i class="fa-solid fa-sync-alt" style="color:#e8c670"></i></span> Practice
      <span><i class="fa-solid fa-user" style="color:#000"></i></span> Author
    </div>
  </header>
  <div id="viz"></div>
  <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
  <script>
  (function(){
    var endpoint="/api/graph";
    var container=document.getElementById("viz");
    var togglePhysics=true;
    var colors={PHILOSOPHY:"#b4c8a8",DOGMA:"#e8b7b7",PRACTICE:"#e8c670"};
    function id(o){return(o&&(o.id||o.identity||o.elementId||(o.properties&&o.properties.id)))||null;}
    function label(o){if(o&&o.properties){if(o.properties.title)return o.properties.title;if(o.properties.name)return o.properties.name;}return(o.labels&&o.labels[0])||"Node";}
    function descf(o){var p=o.properties||{};return p.description&&p.description.trim()?p.description:"No description available.";}
    function build(n){
      var p=(n.labels&&n.labels[0])||"Node";
      var b={id:id(n),label:label(n),group:p,_desc:descf(n)};
      if(p.toUpperCase()==="AUTHOR"){
        b.shape="icon";b.icon={face:"FontAwesome",code:"\uf007",size:30,color:"#000"};
      } else if(p.toUpperCase()==="PHILOSOPHY"){
        b.shape="icon";b.icon={face:"FontAwesome",code:"\uf5dc",size:35,color:colors.PHILOSOPHY};
      } else if(p.toUpperCase()==="PRACTICE"){
        b.shape="icon";b.icon={face:"FontAwesome",code:"\uf2f1",size:35,color:colors.PRACTICE};
      } else if(p.toUpperCase()==="DOGMA"){
        b.shape="icon";b.icon={face:"FontAwesome",code:"\uf19c",size:30,color:colors.DOGMA};
      } else {
        b.color={background:"#d5c7b3",border:"#333"};
      }
      return b;
    }
    fetch(endpoint+"?limit=1000").then(r=>r.json()).then(d=>{
      var rows=(d&&d.data&&d.data.values)||[],nodes=[],edges=[];
      rows.forEach(r=>{if(r[0])nodes.push(r[0]);if(r[2])nodes.push(r[2]);if(r[1])edges.push(r[1]);});
      var nodeMap=new Map(),edgeMap=new Map();
      nodes.forEach(n=>{var i=id(n);if(i&&!nodeMap.has(i))nodeMap.set(i,build(n));});
      edges.forEach(e=>{var i=id(e),f=e.startNodeElementId||e.start||e.from,t=e.endNodeElementId||e.end||e.to;
        if(i&&f&&t&&!edgeMap.has(i)){edgeMap.set(i,{id:i,from:f,to:t,arrows:"to",length:260,color:{color:"#d5c7b3"}});}});
      var net=new vis.Network(container,{nodes:[...nodeMap.values()],edges:[...edgeMap.values()]},
        {edges:{smooth:false},physics:{enabled:togglePhysics,solver:"forceAtlas2Based",forceAtlas2Based:{avoidOverlap:1,springLength:260}}});
    });
  })();
  </script>
</body>
</html>