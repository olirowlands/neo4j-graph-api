<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hypomnemata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#f9f8f5; --card:#3a3a3a; --text:#000000; --muted:#555555; --accent:#ff6f00; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--text);
      font:14px/1.5 "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { display:grid; grid-template-rows:auto 1fr; height:100%; }
    header { padding:14px 16px; background:var(--card); display:flex; gap:12px; align-items:center;
      position:sticky; top:0; z-index:1; border-bottom:1px solid #2b3242; }
    header h1 { font-size:16px; margin:0 8px 0 0; letter-spacing:.2px; color:white; }
    #viz { height: calc(100vh - 64px); }
    .legend { display:flex; gap:10px; align-items:center; margin-left:auto; color:white; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .legend small { color:white; font-size:12px; font-weight:500; }
  </style>
  <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Hypomnemata</h1>
      <div class="legend">
        <span class="dot" style="background:#b4c8a8"></span><small>Philosophy</small>
        <span class="dot" style="background:#e8b7b7"></span><small>Dogma</small>
      </div>
    </header>
    <div id="viz"></div>
  </div>
  <script>
  (function () {
    var endpoint = "/api/graph";
    var el = document.getElementById('viz');
    var labelColor = { PHILOSOPHY:"#b4c8a8", DOGMA:"#e8b7b7", CONCEPT:"#b8cde2", PRACTICE:"#f3d9a4", RELATION:"#d5c7b3" };

    function toId(obj){return (obj&&(obj.id||obj.identity||obj.elementId||(obj.properties&&obj.properties.id)))||null;}
    function labelOf(obj){if(obj&&obj.properties){if(obj.properties.title)return obj.properties.title;if(obj.properties.name)return obj.properties.name;}
      if(obj&&obj.labels&&obj.labels[0])return obj.labels[0];return "Node";}
    function tooltipForNode(n){var props=(n&&n.properties)?n.properties:{};if(props.description&&props.description.trim()!==""){return props.description;}return "No description available";}

    function load(limit){
      el.innerHTML="";
      fetch(endpoint+"?limit="+limit)
        .then(function(res){return res.json();})
        .then(function(payload){
          console.log("PAYLOAD",payload);
          var rows=(payload&&payload.data&&payload.data.values)?payload.data.values:[];
          console.log("ROWS",rows);
          var rawNodes=[],rawEdges=[];
          rows.forEach(function(v){if(v[0])rawNodes.push(v[0]);if(v[2])rawNodes.push(v[2]);if(v[1])rawEdges.push(v[1]);});
          console.log("RAW NODES",rawNodes);
          console.log("RAW EDGES",rawEdges);
          var nodeMap=new Map();
          rawNodes.forEach(function(n){var id=toId(n);if(!id||nodeMap.has(id))return;var primary=(n.labels&&n.labels[0])?n.labels[0]:"Node";
            nodeMap.set(id,{id:id,label:labelOf(n),group:primary,title:tooltipForNode(n),
              color:{background:labelColor[primary]||"#d5c7b3",border:"#333"}});});
          var edgeMap=new Map();
          rawEdges.forEach(function(e){var id=toId(e);var from=e.startNodeElementId||e.start||e.from;var to=e.endNodeElementId||e.end||e.to;
            if(!id||!from||!to||edgeMap.has(id))return;
            var formattedLabel=e.type?"<i>"+e.type.replace(/_/g," ").toLowerCase().replace(/^\w/,function(c){return c.toUpperCase();})+"</i>":"";
            edgeMap.set(id,{id:id,from:from,to:to,label:formattedLabel,arrows:"to",length:200,color:{color:"#d5c7b3",highlight:"#d5c7b3"}});});
          var visNodes=new vis.DataSet(Array.from(nodeMap.values()));
          var visEdges=new vis.DataSet(Array.from(edgeMap.values()));
          console.log("VIS NODES",visNodes.get());
          console.log("VIS EDGES",visEdges.get());
          var network=new vis.Network(el,{nodes:visNodes,edges:visEdges},{
            nodes:{shape:"dot",size:20,borderWidth:2,font:{color:"#000000",size:16,face:"Inter, system-ui"}},
            edges:{width:1.5,color:{color:"#d5c7b3",highlight:"#d5c7b3"},smooth:{type:"dynamic"},font:{multi:"html",face:"Inter",color:"#000000"}},
            interaction:{hover:true,tooltipDelay:150},
            physics:{enabled:true,solver:"forceAtlas2Based",
              forceAtlas2Based:{gravitationalConstant:-30,centralGravity:0.005,springLength:200,springConstant:0.05},
              stabilization:{iterations:200}}
          });
          network.once("stabilizationIterationsDone",function(){network.setOptions({physics:{enabled:false}});network.fit();});
        });
    }
    load(1000);
  })();
  </script>
</body>
</html>