<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hypomnemata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Font Awesome for legend preview AND for vis-network icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    :root {
      --bg:#f9f8f5;
      --card:#3a3a3a;
      --text:#000000;
      --border:#2b3242;
      --footer-bg:#3a3a3a;
      --footer-text:#f9f8f5;
      --highlight:#d4a44b;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.5 "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      overflow: hidden;
    }

    .wrap {
      height: 100vh;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    header {
      flex: 0 0 auto;
      height: 56px;
      box-sizing: border-box;
      padding: 14px 16px;
      background: var(--card);
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }

    header h1 {
      font-size: 16px;
      margin: 0 8px 0 0;
      letter-spacing: .2px;
      color: white;
    }

    .legend {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-left: auto;
      color: white;
      font-size: 12px;
      font-weight: 500;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .author-icon {
      width: 12px;
      height: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #000000;
      background: #ffffff;
      border-radius: 50%;
      border: 1px solid #000000;
      font-size: 9px;
      line-height: 1;
    }

    #viz {
      flex: 0 0 auto;
      height: calc(100vh - 56px - 200px);
      min-height: 0;
      position: relative;
      background: transparent;
      z-index: 0;
      overflow: hidden;
    }

    #details {
      flex: 0 0 auto;
      background: var(--footer-bg);
      color: var(--footer-text);
      border-top: 1px solid #4a4a4a;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.25);
      padding: 20px 0 24px;
      font-size: 14px;
      line-height: 1.5;
    }

    .details-inner {
      max-width: 960px;
      margin: 0 auto;
      width: 100%;
      padding: 0 24px;
      min-height: 140px;
    }

    #details h2 {
      margin: 0 0 6px;
      font-size: 16px;
      font-weight: 600;
      color: var(--footer-text);
      line-height: 1.3;
    }

    #details .meta {
      font-size: 12px;
      font-weight: 500;
      color: #ccc;
      margin-bottom: 6px;
      text-transform: capitalize;
      line-height: 1.2;
    }

    #details .desc {
      font-size: 13px;
      color: var(--footer-text);
      white-space: pre-wrap;
      line-height: 1.5;
    }

    /* Critical: give vis-network a font-family called "FontAwesome" that maps to FA6 Free Solid
       so shape:'icon' can render \uf007 and \uf5dc. */
    @font-face {
      font-family: "FontAwesome";
      font-weight: 900;
      src: local("Font Awesome 6 Free");
    }
  </style>

  <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Hypomnemata</h1>
      <div class="legend">
        <span class="dot" style="background:#b4c8a8"></span><small>Philosophy</small>
        <span class="dot" style="background:#e8b7b7"></span><small>Dogma</small>
        <span class="dot" style="background:#f3d9a4"></span><small>Practice</small>
        <span class="author-icon"><i class="fa-solid fa-user"></i></span><small>Author</small>
      </div>
    </header>

    <div id="viz"></div>

    <section id="details">
      <div class="details-inner">
        <h2 id="details-title">Select a node</h2>
        <div class="meta" id="details-type">â€”</div>
        <div class="desc" id="details-desc">Click any node in the graph to see its description here.</div>
      </div>
    </section>
  </div>

  <script>
  (function () {
    var endpoint = "/api/graph";
    var container = document.getElementById("viz");

    var panelTitle = document.getElementById("details-title");
    var panelType  = document.getElementById("details-type");
    var panelDesc  = document.getElementById("details-desc");

    var labelColor = {
      PHILOSOPHY: "#b4c8a8",
      DOGMA: "#e8b7b7",
      CONCEPT: "#b8cde2",
      PRACTICE: "#f3d9a4",
      RELATION: "#d5c7b3"
      // AUTHOR handled separately
    };

    function toId(obj) {
      return (obj && (obj.id || obj.identity || obj.elementId || (obj.properties && obj.properties.id))) || null;
    }

    function nodeLabel(obj) {
      if (obj && obj.properties) {
        if (obj.properties.title) return obj.properties.title;
        if (obj.properties.name)  return obj.properties.name;
      }
      if (obj && obj.labels && obj.labels[0]) return obj.labels[0];
      return "Node";
    }

    function nodeDescription(obj) {
      var props = (obj && obj.properties) ? obj.properties : {};
      if (props.description && props.description.trim() !== "") {
        return props.description;
      }
      return "No description available.";
    }

    function nodeType(obj) {
      if (obj && obj.labels && obj.labels[0]) {
        return obj.labels[0].toLowerCase();
      }
      return "node";
    }

    function primaryLabel(n){
      return (n.labels && n.labels[0]) ? n.labels[0] : "Node";
    }

    function isAuthor(primary) {
      return primary.toUpperCase() === "AUTHOR";
    }

    function isPhilosophy(primary) {
      return primary.toUpperCase() === "PHILOSOPHY";
    }

    // Build node map entry
    function buildNodeOptions(n) {
      var primary = primaryLabel(n);

      var base = {
        id: toId(n),
        label: nodeLabel(n),
        group: primary,
        _desc: nodeDescription(n),
        _type: nodeType(n)
      };

      if (isPhilosophy(primary)) {
        // Philosophy: brain icon, green
        base.shape = "icon";
        base.icon = {
          face: "FontAwesome",
          code: "\uf5dc",
          size: 23,
          color: "#b4c8a8"
        };
        base._iconOriginal = "#b4c8a8";
      } else if (isAuthor(primary)) {
        // Author: user icon, black
        base.shape = "icon";
        base.icon = {
          face: "FontAwesome",
          code: "\uf007",
          size: 23,
          color: "#000000"
        };
        base._iconOriginal = "#000000";
      } else {
        // Everything else = coloured dot
        base.shape = "dot";
        base.size = 23;
        base.borderWidth = 2;
        base.color = {
          background: labelColor[primary] || "#d5c7b3",
          border: "#333",
          highlight: { background: "#d4a44b", border: "#3a3a3a" },
          hover: { background: "#d4a44b", border: "#3a3a3a" }
        };
        base.font = {
          face: "Inter, system-ui",
          color: "#000000",
          size: 16
        };
      }

      return base;
    }

    function load(limit) {
      fetch(endpoint + "?limit=" + limit)
        .then(function(res){ return res.json(); })
        .then(function(payload){
          var rows = (payload && payload.data && payload.data.values)
            ? payload.data.values
            : [];

          var rawNodes = [];
          var rawEdges = [];

          rows.forEach(function(row){
            if (row[0]) rawNodes.push(row[0]);
            if (row[2]) rawNodes.push(row[2]);
            if (row[1]) rawEdges.push(row[1]);
          });

          var nodeMap = new Map();
          rawNodes.forEach(function(n){
            var id = toId(n);
            if (!id || nodeMap.has(id)) return;
            nodeMap.set(id, buildNodeOptions(n));
          });

          var edgeMap = new Map();
          rawEdges.forEach(function(e){
            var id = toId(e);
            var from = e.startNodeElementId || e.start || e.from;
            var to   = e.endNodeElementId   || e.end   || e.to;
            if (!id || !from || !to || edgeMap.has(id)) return;

            var formattedLabel = "";
            if (e.type) {
              formattedLabel =
                "<i>" +
                e.type.replace(/_/g, " ")
                      .toLowerCase()
                      .replace(/^\w/, function(c){ return c.toUpperCase(); }) +
                "</i>";
            }

            edgeMap.set(id, {
              id: id,
              from: from,
              to: to,
              label: formattedLabel,
              arrows: "to",
              length: 200,
              color: { color: "#d5c7b3", highlight: "#d4a44b", hover: "#d4a44b" }
            });
          });

          var visNodes = new vis.DataSet(Array.from(nodeMap.values()));
          var visEdges = new vis.DataSet(Array.from(edgeMap.values()));

          var network = new vis.Network(container, { nodes: visNodes, edges: visEdges }, {
            nodes: {
              shape: "dot",
              size: 23,
              borderWidth: 2,
              font: { color: "#000000", size: 16, face: "Inter, system-ui" }
            },
            edges: {
              width: 1.5,
              color: { color: "#d5c7b3", highlight: "#d4a44b", hover: "#d4a44b" },
              smooth: { type: "dynamic" },
              font: { multi: "html", face: "Inter", color: "#000000" }
            },
            interaction: { hover: true, tooltipDelay: 150 },
            physics: {
              enabled: true,
              solver: "forceAtlas2Based",
              forceAtlas2Based: {
                gravitationalConstant: -30,
                centralGravity: 0.005,
                springLength: 200,
                springConstant: 0.05
              },
              stabilization: { iterations: 200 }
            }
          });

          network.once("stabilizationIterationsDone", function () {
            network.setOptions({ physics: { enabled: false } });
          });

          // util: reset ALL icon nodes back to normal colour
          function resetIconHighlights() {
            var ids = visNodes.getIds();
            ids.forEach(function(id){
              var n = visNodes.get(id);
              if (!n || n.shape !== "icon") return;
              if (!n._iconOriginal) return;

              // if currently orange, put it back
              if (n.icon && n.icon.color !== n._iconOriginal) {
                visNodes.update({
                  id: id,
                  icon: {
                    face: n.icon.face,
                    code: n.icon.code,
                    size: n.icon.size,
                    color: n._iconOriginal
                  }
                });
              }
            });
          }

          // click handler: set clicked icon node to orange like other nodes
          network.on("click", function (params) {
            if (params.nodes && params.nodes.length > 0) {
              var nodeId = params.nodes[0];
              var data = visNodes.get(nodeId);
              if (!data) return;

              // panel update
              panelTitle.textContent = data.label || "Untitled";
              panelType.textContent  = data._type || "node";
              panelDesc.textContent  = data._desc || "No description available.";

              // highlight logic for icon nodes
              if (data.shape === "icon") {
                resetIconHighlights();
                visNodes.update({
                  id: nodeId,
                  icon: {
                    face: data.icon.face,
                    code: data.icon.code,
                    size: data.icon.size,
                    color: "#d4a44b" // same orange highlight
                  }
                });
              } else {
                // if we clicked a normal dot, still reset icon nodes
                resetIconHighlights();
              }
            } else {
              // clicked on background -> clear icon highlight
              resetIconHighlights();
            }
          });

          // also highlight icon node on hover-in and unhighlight on hover-out
          network.on("hoverNode", function (params) {
            var n = visNodes.get(params.node);
            if (!n || n.shape !== "icon") return;
            // temporarily set orange
            visNodes.update({
              id: n.id,
              icon: {
                face: n.icon.face,
                code: n.icon.code,
                size: n.icon.size,
                color: "#d4a44b"
              }
            });
          });

          network.on("blurNode", function (params) {
            var n = visNodes.get(params.node);
            if (!n || n.shape !== "icon") return;
            // restore only if it's not also the selected one
            // we'll just call resetIconHighlights() which respects selected node later through click
            resetIconHighlights();
          });
        });
    }

    load(1000);
  })();
  </script>
</body>
</html>
