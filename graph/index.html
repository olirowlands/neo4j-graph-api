<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hypomnemata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:#f9f8f5;
      --card:#3a3a3a;
      --text:#000000;
      --border:#2b3242;
      --footer-bg:#3a3a3a;
      --footer-text:#f9f8f5;
      --highlight:#d4a44b;

      /* New palette entries */
      --philosophy-color:#b4c8a8;
      --dogma-color:#e8b7b7;
      --exercise-color:#f3d9a4;
      --author-color:#F59E0B; /* amber/gold for Author */
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.5 "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      overflow: hidden;
    }

    .wrap {
      height: 100vh;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    header {
      flex: 0 0 auto;
      height: 56px;
      box-sizing: border-box;
      padding: 14px 16px;
      background: var(--card);
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }

    header h1 {
      font-size: 16px;
      margin: 0 8px 0 0;
      letter-spacing: .2px;
      color: white;
    }

    .legend {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-left: auto;
      color: white;
      font-size: 12px;
      font-weight: 500;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
      border: 1px solid rgba(0,0,0,0.5);
      box-shadow: 0 2px 4px rgba(0,0,0,0.5), 0 0 2px rgba(255,255,255,0.2) inset;
    }

    /* Special chip for Author with icon */
    .dot-author {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: var(--author-color);
      border: 1px solid rgba(0,0,0,0.5);
      box-shadow: 0 2px 4px rgba(0,0,0,0.5), 0 0 2px rgba(255,255,255,0.2) inset;
      display: flex;
      align-items: center;
      justify-content: center;
      color:#1E1E1E;
      font-size:0;
    }

    .dot-author svg {
      width: 12px;
      height: 12px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    #viz {
      flex: 0 0 auto;
      height: calc(100vh - 56px - 200px);
      min-height: 0;
      position: relative;
      background: transparent;
      z-index: 0;
      overflow: hidden;
    }

    #details {
      flex: 0 0 auto;
      background: var(--footer-bg);
      color: var(--footer-text);
      border-top: 1px solid #4a4a4a;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.25);
      padding: 20px 0 24px;
      font-size: 14px;
      line-height: 1.5;
    }

    .details-inner {
      max-width: 960px;
      margin: 0 auto;
      width: 100%;
      padding: 0 24px;
      min-height: 140px;
    }

    #details h2 {
      margin: 0 0 6px;
      font-size: 16px;
      font-weight: 600;
      color: var(--footer-text);
      line-height: 1.3;
    }

    #details .meta {
      font-size: 12px;
      font-weight: 500;
      color: #ccc;
      margin-bottom: 6px;
      text-transform: capitalize;
      line-height: 1.2;
    }

    #details .desc {
      font-size: 13px;
      color: var(--footer-text);
      white-space: pre-wrap;
      line-height: 1.5;
    }
  </style>

  <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Hypomnemata</h1>

      <div class="legend">
        <div class="legend-item">
          <span class="dot" style="background:var(--philosophy-color)"></span>
          <small>Philosophy</small>
        </div>

        <div class="legend-item">
          <span class="dot" style="background:var(--dogma-color)"></span>
          <small>Dogma</small>
        </div>

        <div class="legend-item">
          <span class="dot" style="background:var(--exercise-color)"></span>
          <small>Exercise</small>
        </div>

        <div class="legend-item">
          <span class="dot-author">
            <!-- person icon -->
            <svg viewBox="0 0 24 24">
              <circle cx="12" cy="8" r="4"></circle>
              <path d="M4 20c0-4 4-6 8-6s8 2 8 6"></path>
            </svg>
          </span>
          <small>Author</small>
        </div>
      </div>
    </header>

    <div id="viz"></div>

    <section id="details">
      <div class="details-inner">
        <h2 id="details-title">Select a node</h2>
        <div class="meta" id="details-type">â€”</div>
        <div class="desc" id="details-desc">Click any node in the graph to see its description here.</div>
      </div>
    </section>
  </div>

  <script>
  (function () {
    var endpoint = "/api/graph";
    var container = document.getElementById("viz");

    var panelTitle = document.getElementById("details-title");
    var panelType  = document.getElementById("details-type");
    var panelDesc  = document.getElementById("details-desc");

    var labelColor = {
      PHILOSOPHY: "var(--philosophy-color)",
      DOGMA: "var(--dogma-color)",
      CONCEPT: "#b8cde2",
      PRACTICE: "var(--exercise-color)",
      RELATION: "#d5c7b3",
      AUTHOR: "var(--author-color)"
    };

    var AUTHOR_SVG_DATAURI =
      'data:image/svg+xml;utf8,' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="%23F59E0B" stroke="none">' +
      '<circle cx="12" cy="8" r="5"/>' +
      '<path d="M4 21c0-4.5 4-7 8-7s8 2.5 8 7" />' +
      '</svg>';

    function toId(obj) {
      return (obj && (obj.id || obj.identity || obj.elementId || (obj.properties && obj.properties.id))) || null;
    }

    function nodePrimaryLabel(obj) {
      if (obj && obj.labels && obj.labels.length > 0) {
        return obj.labels[0];
      }
      return "Node";
    }

    function nodeLabel(obj) {
      if (obj && obj.properties) {
        if (obj.properties.title) return obj.properties.title;
        if (obj.properties.name)  return obj.properties.name;
      }
      var p = nodePrimaryLabel(obj);
      return p;
    }

    function nodeDescription(obj) {
      var props = (obj && obj.properties) ? obj.properties : {};
      if (props.description && props.description.trim() !== "") {
        return props.description;
      }
      return "No description available.";
    }

    function nodeType(obj) {
      if (obj && obj.labels && obj.labels[0]) {
        return obj.labels[0].toLowerCase();
      }
      return "node";
    }

    function makeVisNode(n) {
      var id = toId(n);
      var primary = nodePrimaryLabel(n);
      var base = {
        id: id,
        label: nodeLabel(n),
        group: primary,
        _desc: nodeDescription(n),
        _type: nodeType(n)
      };

      var defaultColor = labelColor[primary] || "#d5c7b3";

      var styled = {
        shape: "dot",
        size: 20,
        color: {
          background: defaultColor,
          border: "#333",
          highlight: { background: "#d4a44b", border: "#3a3a3a" },
          hover: { background: "#d4a44b", border: "#3a3a3a" }
        },
        font: {
          color: "#000000",
          size: 16,
          face: "Inter, system-ui"
        }
      };

      if (primary === "Author" || primary === "AUTHOR") {
        styled = {
          shape: "image",
          image: AUTHOR_SVG_DATAURI,
          size: 30,
          font: {
            color: "#000000",
            size: 16,
            face: "Inter, system-ui"
          },
          color: {
            background: "var(--author-color)",
            border: "#333",
            highlight: { background: "#d4a44b", border: "#3a3a3a" },
            hover: { background: "#d4a44b", border: "#3a3a3a" }
          }
        };
      }

      return Object.assign(base, styled);
    }

    function makeVisEdge(e) {
      var id   = toId(e);
      var from = e.startNodeElementId || e.start || e.from;
      var to   = e.endNodeElementId   || e.end   || e.to;
      if (!id || !from || !to) return null;

      var formattedLabel = "";
      if (e.type) {
        formattedLabel =
          "<i>" +
          e.type
            .replace(/_/g, " ")
            .toLowerCase()
            .replace(/^\w/, function(c){ return c.toUpperCase(); }) +
          "</i>";
      }

      return {
        id: id,
        from: from,
        to: to,
        label: formattedLabel,
        arrows: "to",
        length: 200,
        color: { color: "#d5c7b3", highlight: "#d4a44b", hover: "#d4a44b" },
        font: { multi: "html", face: "Inter", color: "#000000" }
      };
    }

    function load(limit) {
      fetch(endpoint + "?limit=" + limit)
        .then(function(res){ return res.json(); })
        .then(function(payload){
          var rows = (payload && payload.data && payload.data.values)
            ? payload.data.values
            : [];

          var rawNodes = [];
          var rawEdges = [];

          rows.forEach(function(row){
            if (row[0]) rawNodes.push(row[0]);
            if (row[2]) rawNodes.push(row[2]);
            if (row[1]) rawEdges.push(row[1]);
          });

          var nodeMap = new Map();
          rawNodes.forEach(function(n){
            var id = toId(n);
            if (!id || nodeMap.has(id)) return;
            nodeMap.set(id, makeVisNode(n));
          });

          var edgeMap = new Map();
          rawEdges.forEach(function(e){
            var built = makeVisEdge(e);
            if (!built || edgeMap.has(built.id)) return;
            edgeMap.set(built.id, built);
          });

          var visNodes = new vis.DataSet(Array.from(nodeMap.values()));
          var visEdges = new vis.DataSet(Array.from(edgeMap.values()));

          var network = new vis.Network(container, { nodes: visNodes, edges: visEdges }, {
            nodes: {
              shape: "dot",
              size: 20,
              borderWidth: 2,
              font: { color: "#000000", size: 16, face: "Inter, system-ui" }
            },
            edges: {
              width: 1.5,
              color: { color: "#d5c7b3", highlight: "#d4a44b", hover: "#d4a44b" },
              smooth: { type: "dynamic" },
              font: { multi: "html", face: "Inter", color: "#000000" }
            },
            interaction: { hover: true, tooltipDelay: 150 },
            physics: {
              enabled: true,
              solver: "forceAtlas2Based",
              forceAtlas2Based: { gravitationalConstant: -30, centralGravity: 0.005, springLength: 200, springConstant: 0.05 },
              stabilization: { iterations: 200 }
            }
          });

          network.once("stabilizationIterationsDone", function () {
            network.setOptions({ physics: { enabled: false } });
          });

          network.on("click", function (params) {
            if (params.nodes && params.nodes.length > 0) {
              var nodeId = params.nodes[0];
              var data = visNodes.get(nodeId);
              if (!data) return;

              panelTitle.textContent = data.label || "Untitled";
              panelType.textContent  = data._type || "node";
              panelDesc.textContent  = data._desc || "No description available.";
            }
          });
        });
    }

    load(1000);
  })();
  </script>
</body>
</html>